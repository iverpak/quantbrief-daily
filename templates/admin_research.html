<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Tools - StockDigest Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: #ffffff;
            padding: 24px 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header .back-link {
            display: inline-block;
            color: #ffffff;
            text-decoration: none;
            margin-bottom: 12px;
            opacity: 0.9;
            font-size: 14px;
        }

        .header .back-link:hover {
            opacity: 1;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #1e40af;
        }

        .tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
        }

        .tab-content {
            background: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content h2 {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #1e40af;
        }

        button {
            background: #1e40af;
            color: #ffffff;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #1e3a8a;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .validation-result {
            margin-top: 12px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .validation-result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .validation-result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .validation-result.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #1e40af;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/admin?token={{ token }}" class="back-link">‚Üê Back to Dashboard</a>
        <h1>üìë Research Tools</h1>
        <p>Generate AI summaries of earnings transcripts, press releases, and company profiles</p>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('transcripts', event)">Earnings Transcripts</button>
            <button class="tab" onclick="switchTab('press-releases', event)">Press Releases</button>
            <button class="tab" onclick="switchTab('company-profiles', event)">Company Profiles</button>
        </div>

        <!-- Earnings Transcripts Tab -->
        <div id="transcripts-tab" class="tab-content">
            <h2>Generate Earnings Transcript Summary</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Fetch earnings call transcripts from FMP and generate AI summaries using Claude.
            </p>

            <div class="input-group">
                <label>Ticker Symbol <span style="color: #dc2626;">*</span></label>
                <input type="text" id="transcript-ticker" placeholder="e.g., AAPL, TSLA, RY.TO"
                       style="text-transform: uppercase;">
                <button onclick="validateTickerForTranscript()" style="margin-top: 8px;">Validate Ticker</button>
            </div>

            <div id="transcript-validation-result"></div>

            <div id="transcript-quarter-section" style="display:none; margin-top: 24px;">
                <div class="input-group">
                    <label>Select Quarter <span style="color: #dc2626;">*</span></label>
                    <select id="transcript-quarter">
                        <option value="">Validate ticker first...</option>
                    </select>
                </div>

                <button onclick="generateTranscriptSummary()"
                        style="margin-top: 20px; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                               padding: 12px 24px; font-size: 15px; font-weight: 600;">
                    üöÄ Generate Summary (30-60 sec)
                </button>
            </div>

            <div id="transcript-result" style="display:none; margin-top: 24px; padding: 16px;
                                              background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #166534; font-size: 15px;">
                    ‚úÖ Transcript summary generated successfully!
                </p>
                <p style="margin: 8px 0 0 0; font-size: 14px; color: #166534;">
                    Check your email for the full summary. The summary has been saved to the database.
                </p>
            </div>

            <div id="transcript-error" style="display:none; margin-top: 24px; padding: 16px;
                                             background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b; font-size: 15px;">
                    ‚ùå Summary generation failed
                </p>
                <p id="transcript-error-message" style="margin: 8px 0 0 0; font-size: 14px; color: #991b1b;">
                    Error details will appear here.
                </p>
            </div>
        </div>

        <!-- Press Releases Tab -->
        <div id="press-releases-tab" class="tab-content" style="display:none;">
            <h2>Generate Press Release Summary</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Fetch press releases from FMP and generate AI summaries using Claude.
            </p>

            <div class="input-group">
                <label>Ticker Symbol <span style="color: #dc2626;">*</span></label>
                <input type="text" id="pr-ticker" placeholder="e.g., AAPL, TSLA, RY.TO"
                       style="text-transform: uppercase;">
                <button onclick="validateTickerForPR()" style="margin-top: 8px;">Validate Ticker</button>
            </div>

            <div id="pr-validation-result"></div>

            <div id="pr-release-section" style="display:none; margin-top: 24px;">
                <div class="input-group">
                    <label>Select Press Release <span style="color: #dc2626;">*</span></label>
                    <select id="pr-release">
                        <option value="">Validate ticker first...</option>
                    </select>
                </div>

                <button onclick="generatePRSummary()"
                        style="margin-top: 20px; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                               padding: 12px 24px; font-size: 15px; font-weight: 600;">
                    üöÄ Generate Summary (30-60 sec)
                </button>
            </div>

            <div id="pr-result" style="display:none; margin-top: 24px; padding: 16px;
                                      background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #166534; font-size: 15px;">
                    ‚úÖ Press release summary generated successfully!
                </p>
                <p style="margin: 8px 0 0 0; font-size: 14px; color: #166534;">
                    Check your email for the full summary. The summary has been saved to the database.
                </p>
            </div>

            <div id="pr-error" style="display:none; margin-top: 24px; padding: 16px;
                                     background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b; font-size: 15px;">
                    ‚ùå Summary generation failed
                </p>
                <p id="pr-error-message" style="margin: 8px 0 0 0; font-size: 14px; color: #991b1b;">
                    Error details will appear here.
                </p>
            </div>
        </div>

        <!-- Company Profiles Tab -->
        <div id="company-profiles-tab" class="tab-content" style="display:none;">
            <h2>Generate Company Profile</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Upload a 10-K PDF or TXT file to generate a comprehensive company profile using Gemini 2.5 Flash AI.
                Processing takes 5-10 minutes.
            </p>

            <!-- Step 1: Ticker Input -->
            <div class="input-group">
                <label>Ticker Symbol <span style="color: #dc2626;">*</span></label>
                <input type="text" id="profile-ticker" placeholder="e.g., TSLA, AAPL, RY.TO"
                       style="text-transform: uppercase;">
                <button onclick="validateTickerForProfile()" style="margin-top: 8px;">Validate Ticker</button>
            </div>

            <div id="profile-validation-result"></div>

            <!-- Step 2: File Upload (shown after validation) -->
            <div id="profile-upload-section" style="display:none; margin-top: 24px;">
                <div class="input-group">
                    <label>Upload 10-K Filing <span style="color: #dc2626;">*</span></label>
                    <input type="file" id="profile-file-upload" accept=".pdf,.txt"
                           style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                    <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        Supported formats: PDF, TXT (max 300 pages)
                    </p>
                </div>

                <div class="input-group" style="margin-top: 16px;">
                    <label>Fiscal Year <span style="color: #dc2626;">*</span></label>
                    <input type="number" id="profile-fiscal-year" placeholder="e.g., 2024"
                           min="2000" max="2030" style="width: 150px;">
                </div>

                <div class="input-group" style="margin-top: 16px;">
                    <label>Filing Date <span style="color: #dc2626;">*</span></label>
                    <input type="date" id="profile-filing-date" style="width: 200px;">
                </div>

                <button onclick="generateCompanyProfile()"
                        style="margin-top: 20px; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                               padding: 12px 24px; font-size: 15px; font-weight: 600;">
                    üöÄ Generate Profile (5-10 min)
                </button>
            </div>

            <!-- Step 3: Job Status (shown during processing) -->
            <div id="profile-job-status" style="display:none; margin-top: 32px;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Processing...</h3>

                <div style="background: #f3f4f6; border-radius: 8px; overflow: hidden; height: 40px; position: relative;">
                    <div id="profile-progress"
                         style="width: 0%; height: 100%; background: linear-gradient(90deg, #1e3a8a, #1e40af);
                                transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <span id="profile-progress-text" style="color: white; font-weight: 600; font-size: 14px;
                                                                position: absolute; left: 50%; transform: translateX(-50%);">
                            0%
                        </span>
                    </div>
                </div>

                <p id="profile-status-text" style="margin-top: 12px; font-size: 14px; color: #4b5563;">
                    Extracting 10-K text...
                </p>

                <p id="profile-time-estimate" style="font-size: 12px; color: #9ca3af; margin-top: 4px;">
                    Estimated time: 5-10 minutes
                </p>
            </div>

            <!-- Step 4: Result Display -->
            <div id="profile-result" style="display:none; margin-top: 24px; padding: 16px;
                                            background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #166534; font-size: 15px;">
                    ‚úÖ Company profile generated successfully!
                </p>
                <p style="margin: 8px 0 0 0; font-size: 14px; color: #166534;">
                    Check your email for the full profile. The profile has been saved to the database.
                </p>
            </div>

            <div id="profile-error" style="display:none; margin-top: 24px; padding: 16px;
                                           background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b; font-size: 15px;">
                    ‚ùå Profile generation failed
                </p>
                <p id="profile-error-message" style="margin: 8px 0 0 0; font-size: 14px; color: #991b1b;">
                    Error details will appear here.
                </p>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>StockDigest Research Tools | <a href="mailto:stockdigest.research@gmail.com" style="color: #1e40af;">Contact Support</a></p>
    </div>

    <script>
        const token = '{{ token }}';

        // =============================================================================
        // TAB SWITCHING
        // =============================================================================

        function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
        }

        // =============================================================================
        // EARNINGS TRANSCRIPTS TAB
        // =============================================================================

        async function validateTickerForTranscript() {
            const ticker = document.getElementById('transcript-ticker').value.toUpperCase().trim();
            const resultDiv = document.getElementById('transcript-validation-result');

            if (!ticker) {
                resultDiv.innerHTML = '<div class="validation-result error">‚ö†Ô∏è Please enter a ticker symbol</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="validation-result">Validating ticker...</div>';

            try {
                const response = await fetch(`/api/fmp-validate-ticker?ticker=${ticker}&type=transcript`);
                const data = await response.json();

                if (data.valid) {
                    const select = document.getElementById('transcript-quarter');
                    select.innerHTML = '';

                    if (data.available_quarters && data.available_quarters.length > 0) {
                        data.available_quarters.forEach((q, index) => {
                            const option = document.createElement('option');
                            option.value = q;
                            option.textContent = q + (index === 0 ? ' (Latest)' : '');
                            if (index === 0) option.selected = true;
                            select.appendChild(option);
                        });

                        resultDiv.innerHTML = `
                            <div class="validation-result success">
                                ‚úÖ ${ticker} - ${data.company_name}<br>
                                <span style="font-size: 12px; color: #059669;">${data.available_quarters.length} transcripts available</span>
                            </div>
                        `;

                        document.getElementById('transcript-quarter-section').style.display = 'block';
                    } else {
                        resultDiv.innerHTML = `<div class="validation-result error">‚ùå No transcripts available for ${ticker}</div>`;
                        document.getElementById('transcript-quarter-section').style.display = 'none';
                    }
                } else {
                    resultDiv.innerHTML = `<div class="validation-result error">‚ùå ${data.error}</div>`;
                    document.getElementById('transcript-quarter-section').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="validation-result error">‚ùå Validation failed: ${error.message}</div>`;
            }
        }

        async function generateTranscriptSummary() {
            const ticker = document.getElementById('transcript-ticker').value.toUpperCase().trim();
            const quarterStr = document.getElementById('transcript-quarter').value;

            if (!ticker || !quarterStr) {
                alert('Please validate ticker and select a quarter first');
                return;
            }

            // Parse "Q3 2024" into quarter=3, year=2024
            const match = quarterStr.match(/Q(\d+)\s+(\d{4})/);
            if (!match) {
                alert('Invalid quarter format');
                return;
            }

            const quarter = parseInt(match[1]);
            const year = parseInt(match[2]);

            // Hide sections, show processing
            document.getElementById('transcript-quarter-section').style.display = 'none';
            document.getElementById('transcript-result').style.display = 'none';
            document.getElementById('transcript-error').style.display = 'none';

            try {
                const response = await fetch('/api/admin/generate-transcript-summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        report_type: 'transcript',
                        quarter: quarter,
                        year: year
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('transcript-result').style.display = 'block';
                } else {
                    document.getElementById('transcript-error').style.display = 'block';
                    document.getElementById('transcript-error-message').textContent = result.message;
                    document.getElementById('transcript-quarter-section').style.display = 'block';
                }

            } catch (error) {
                document.getElementById('transcript-error').style.display = 'block';
                document.getElementById('transcript-error-message').textContent = error.message;
                document.getElementById('transcript-quarter-section').style.display = 'block';
            }
        }

        // =============================================================================
        // PRESS RELEASES TAB
        // =============================================================================

        async function validateTickerForPR() {
            const ticker = document.getElementById('pr-ticker').value.toUpperCase().trim();
            const resultDiv = document.getElementById('pr-validation-result');

            if (!ticker) {
                resultDiv.innerHTML = '<div class="validation-result error">‚ö†Ô∏è Please enter a ticker symbol</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="validation-result">Validating ticker...</div>';

            try {
                const response = await fetch(`/api/fmp-validate-ticker?ticker=${ticker}&type=press_release`);
                const data = await response.json();

                if (data.valid) {
                    const select = document.getElementById('pr-release');
                    select.innerHTML = '';

                    if (data.available_releases && data.available_releases.length > 0) {
                        data.available_releases.forEach((r, index) => {
                            const option = document.createElement('option');
                            option.value = r.date;
                            option.textContent = `${r.date} - ${r.title}`;
                            if (index === 0) option.selected = true;
                            select.appendChild(option);
                        });

                        resultDiv.innerHTML = `
                            <div class="validation-result success">
                                ‚úÖ ${ticker} - ${data.company_name}<br>
                                <span style="font-size: 12px; color: #059669;">${data.available_releases.length} press releases available</span>
                            </div>
                        `;

                        document.getElementById('pr-release-section').style.display = 'block';
                    } else {
                        resultDiv.innerHTML = `<div class="validation-result error">‚ùå No press releases available for ${ticker}</div>`;
                        document.getElementById('pr-release-section').style.display = 'none';
                    }
                } else {
                    resultDiv.innerHTML = `<div class="validation-result error">‚ùå ${data.error}</div>`;
                    document.getElementById('pr-release-section').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="validation-result error">‚ùå Validation failed: ${error.message}</div>`;
            }
        }

        async function generatePRSummary() {
            const ticker = document.getElementById('pr-ticker').value.toUpperCase().trim();
            const prDate = document.getElementById('pr-release').value;

            if (!ticker || !prDate) {
                alert('Please validate ticker and select a press release first');
                return;
            }

            // Hide sections, show processing
            document.getElementById('pr-release-section').style.display = 'none';
            document.getElementById('pr-result').style.display = 'none';
            document.getElementById('pr-error').style.display = 'none';

            try {
                const response = await fetch('/api/admin/generate-transcript-summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        report_type: 'press_release',
                        pr_date: prDate
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('pr-result').style.display = 'block';
                } else {
                    document.getElementById('pr-error').style.display = 'block';
                    document.getElementById('pr-error-message').textContent = result.message;
                    document.getElementById('pr-release-section').style.display = 'block';
                }

            } catch (error) {
                document.getElementById('pr-error').style.display = 'block';
                document.getElementById('pr-error-message').textContent = error.message;
                document.getElementById('pr-release-section').style.display = 'block';
            }
        }

        // =============================================================================
        // COMPANY PROFILES TAB
        // =============================================================================

        async function validateTickerForProfile() {
            const ticker = document.getElementById('profile-ticker').value.toUpperCase().trim();
            const resultDiv = document.getElementById('profile-validation-result');

            if (!ticker) {
                resultDiv.innerHTML = '<div class="validation-result error">‚ö†Ô∏è Please enter a ticker symbol</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="validation-result">Validating ticker...</div>';

            try {
                const response = await fetch(`/api/fmp-validate-ticker?ticker=${ticker}&type=profile`);
                const data = await response.json();

                if (data.valid) {
                    resultDiv.innerHTML = `
                        <div class="validation-result success">
                            ‚úÖ ${ticker} - ${data.company_name} (${data.industry})<br>
                            <span style="font-size: 12px; color: #059669;">${data.message}</span>
                        </div>
                    `;

                    // Show upload section
                    document.getElementById('profile-upload-section').style.display = 'block';

                    // Set default fiscal year to current year
                    const currentYear = new Date().getFullYear();
                    document.getElementById('profile-fiscal-year').value = currentYear - 1; // Last year's 10-K

                } else {
                    resultDiv.innerHTML = `<div class="validation-result error">‚ùå ${data.error}</div>`;
                    document.getElementById('profile-upload-section').style.display = 'none';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="validation-result error">‚ùå Validation failed: ${error.message}</div>`;
            }
        }

        async function generateCompanyProfile() {
            const ticker = document.getElementById('profile-ticker').value.toUpperCase().trim();
            const fileInput = document.getElementById('profile-file-upload');
            const fiscalYear = parseInt(document.getElementById('profile-fiscal-year').value);
            const filingDate = document.getElementById('profile-filing-date').value;

            // Validation
            if (!ticker) {
                alert('Please enter and validate a ticker symbol first');
                return;
            }

            if (!fileInput.files[0]) {
                alert('Please upload a 10-K file (PDF or TXT)');
                return;
            }

            if (!fiscalYear || fiscalYear < 2000 || fiscalYear > 2030) {
                alert('Please enter a valid fiscal year (2000-2030)');
                return;
            }

            if (!filingDate) {
                alert('Please enter a filing date');
                return;
            }

            // Read file as base64
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                // Convert ArrayBuffer to base64
                const base64Content = btoa(
                    new Uint8Array(e.target.result)
                        .reduce((data, byte) => data + String.fromCharCode(byte), '')
                );

                // Hide upload section, show status
                document.getElementById('profile-upload-section').style.display = 'none';
                document.getElementById('profile-job-status').style.display = 'block';
                document.getElementById('profile-result').style.display = 'none';
                document.getElementById('profile-error').style.display = 'none';

                try {
                    // Create job
                    const response = await fetch('/api/admin/generate-company-profile', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            token: token,
                            ticker: ticker,
                            fiscal_year: fiscalYear,
                            filing_date: filingDate,
                            file_content: base64Content,
                            file_name: file.name
                        })
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        // Start polling job status
                        pollCompanyProfileJobStatus(result.job_id);
                    } else {
                        // Show error
                        document.getElementById('profile-job-status').style.display = 'none';
                        document.getElementById('profile-error').style.display = 'block';
                        document.getElementById('profile-error-message').textContent = result.message;
                        document.getElementById('profile-upload-section').style.display = 'block';
                    }

                } catch (error) {
                    document.getElementById('profile-job-status').style.display = 'none';
                    document.getElementById('profile-error').style.display = 'block';
                    document.getElementById('profile-error-message').textContent = error.message;
                    document.getElementById('profile-upload-section').style.display = 'block';
                }
            };

            reader.readAsArrayBuffer(file);
        }

        async function pollCompanyProfileJobStatus(jobId) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/jobs/${jobId}`);
                    const status = await response.json();

                    // Update progress bar
                    const progress = status.progress || 0;
                    document.getElementById('profile-progress').style.width = progress + '%';
                    document.getElementById('profile-progress-text').textContent = progress + '%';

                    // Update status text
                    const phaseMessages = {
                        'extracting_text': 'Extracting 10-K text...',
                        'generating_profile': 'Generating profile with Gemini 2.5 Flash (5-10 min)...',
                        'saving_profile': 'Saving profile to database...',
                        'sending_email': 'Sending email notification...',
                        'complete': 'Complete!'
                    };

                    document.getElementById('profile-status-text').textContent =
                        phaseMessages[status.phase] || status.phase || 'Processing...';

                    // Update time estimate
                    if (progress < 30) {
                        document.getElementById('profile-time-estimate').textContent = 'Estimated time remaining: 8-10 minutes';
                    } else if (progress < 80) {
                        document.getElementById('profile-time-estimate').textContent = 'Estimated time remaining: 3-5 minutes';
                    } else if (progress < 100) {
                        document.getElementById('profile-time-estimate').textContent = 'Estimated time remaining: < 1 minute';
                    }

                    // Check completion
                    if (status.status === 'completed') {
                        clearInterval(pollInterval);

                        // Show success
                        document.getElementById('profile-job-status').style.display = 'none';
                        document.getElementById('profile-result').style.display = 'block';

                    } else if (status.status === 'failed' || status.status === 'timeout') {
                        clearInterval(pollInterval);

                        // Show error
                        document.getElementById('profile-job-status').style.display = 'none';
                        document.getElementById('profile-error').style.display = 'block';
                        document.getElementById('profile-error-message').textContent =
                            status.error_message || 'Unknown error occurred';
                        document.getElementById('profile-upload-section').style.display = 'block';
                    }

                } catch (error) {
                    clearInterval(pollInterval);

                    document.getElementById('profile-job-status').style.display = 'none';
                    document.getElementById('profile-error').style.display = 'block';
                    document.getElementById('profile-error-message').textContent =
                        'Failed to poll job status: ' + error.message;
                }

            }, 10000); // Poll every 10 seconds
        }
    </script>
</body>
</html>
