<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domain Analytics - StockDigest Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f8f9fa; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: #ffffff; padding: 24px 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .header a { color: #ffffff; text-decoration: none; opacity: 0.8; margin-right: 16px; }
        .header a:hover { opacity: 1; }
        .container { max-width: 1400px; margin: 40px auto; padding: 0 20px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb; }
        .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; font-size: 15px; font-weight: 500; color: #6b7280; transition: all 0.2s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab.active { color: #1e40af; border-bottom-color: #1e40af; }
        .tab:hover { color: #1e40af; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: #ffffff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 24px; }
        .stats-row { display: flex; gap: 16px; margin-bottom: 24px; }
        .stat-box { flex: 1; padding: 16px; background: #f8f9fa; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 32px; font-weight: 700; color: #1e40af; }
        .stat-label { font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e5e7eb; }
        td { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
        tr:hover { background: #f9fafb; }
        .score-high { color: #22c55e; font-weight: 600; }
        .score-med { color: #eab308; font-weight: 600; }
        .score-low { color: #ef4444; font-weight: 600; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="header">
        <a href="/admin?token={{ token }}">‚Üê Dashboard</a>
        <h1>Domain Analytics</h1>
        <p>Quality rankings and scrape health metrics</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('quality')">Quality Rankings</button>
            <button class="tab" onclick="switchTab('scrape')">Scrape Health</button>
        </div>

        <div id="quality-tab" class="tab-content active">
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value" id="total-domains-quality">-</div>
                    <div class="stat-label">Domains Scored</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="avg-quality">-</div>
                    <div class="stat-label">Average Quality</div>
                </div>
            </div>

            <div class="card">
                <div id="quality-loading" class="loading">Loading domain quality data...</div>
                <table id="quality-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Domain</th>
                            <th>Formal Name</th>
                            <th>Quality Score</th>
                            <th>Articles</th>
                            <th>Scrape Rate</th>
                        </tr>
                    </thead>
                    <tbody id="quality-body"></tbody>
                </table>
            </div>
        </div>

        <div id="scrape-tab" class="tab-content">
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value" id="total-domains-scrape">-</div>
                    <div class="stat-label">Domains Tracked</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="avg-scrape-rate">-</div>
                    <div class="stat-label">Avg Success Rate</div>
                </div>
            </div>

            <div class="card">
                <div id="scrape-loading" class="loading">Loading scrape health data...</div>
                <table id="scrape-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Domain</th>
                            <th>Formal Name</th>
                            <th>Attempts</th>
                            <th>Failures</th>
                            <th>Success Rate</th>
                        </tr>
                    </thead>
                    <tbody id="scrape-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const token = "{{ token }}";

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'quality') {
                document.querySelector('[onclick="switchTab(\'quality\')"]').classList.add('active');
                document.getElementById('quality-tab').classList.add('active');
            } else {
                document.querySelector('[onclick="switchTab(\'scrape\')"]').classList.add('active');
                document.getElementById('scrape-tab').classList.add('active');
            }
        }

        function formatScore(score) {
            if (!score) return 'N/A';
            const val = parseFloat(score);
            if (val >= 7.0) return `<span class="score-high">${val.toFixed(1)}</span>`;
            if (val >= 5.0) return `<span class="score-med">${val.toFixed(1)}</span>`;
            return `<span class="score-low">${val.toFixed(1)}</span>`;
        }

        function formatRate(rate) {
            if (!rate) return 'N/A';
            const val = parseFloat(rate);
            if (val >= 80) return `<span class="score-high">${val.toFixed(1)}%</span>`;
            if (val >= 50) return `<span class="score-med">${val.toFixed(1)}%</span>`;
            return `<span class="score-low">${val.toFixed(1)}%</span>`;
        }

        async function loadDomainStats() {
            try {
                const response = await fetch(`/api/get-domain-stats?token=${token}`);
                const data = await response.json();

                if (data.status === 'success') {
                    const domains = data.domains || [];

                    // Quality table
                    const qualityDomains = domains.filter(d => d.quality_count >= 5);
                    document.getElementById('total-domains-quality').textContent = qualityDomains.length;

                    if (qualityDomains.length > 0) {
                        const avgQuality = (qualityDomains.reduce((sum, d) => sum + (d.quality_score_avg || 0), 0) / qualityDomains.length).toFixed(1);
                        document.getElementById('avg-quality').textContent = avgQuality;

                        const qualityBody = document.getElementById('quality-body');
                        qualityBody.innerHTML = qualityDomains
                            .sort((a, b) => (b.quality_score_avg || 0) - (a.quality_score_avg || 0))
                            .map(d => `
                                <tr>
                                    <td>${d.domain}</td>
                                    <td>${d.formal_name || 'N/A'}</td>
                                    <td>${formatScore(d.quality_score_avg)}</td>
                                    <td>${d.quality_count || 0}</td>
                                    <td>${formatRate(d.scrape_success_rate)}</td>
                                </tr>
                            `).join('');

                        document.getElementById('quality-loading').style.display = 'none';
                        document.getElementById('quality-table').style.display = 'table';
                    }

                    // Scrape table
                    const scrapeDomains = domains.filter(d => d.scrape_attempts >= 5);
                    document.getElementById('total-domains-scrape').textContent = scrapeDomains.length;

                    if (scrapeDomains.length > 0) {
                        const avgScrapeRate = (scrapeDomains.reduce((sum, d) => sum + (d.scrape_success_rate || 0), 0) / scrapeDomains.length).toFixed(1);
                        document.getElementById('avg-scrape-rate').textContent = avgScrapeRate + '%';

                        const scrapeBody = document.getElementById('scrape-body');
                        scrapeBody.innerHTML = scrapeDomains
                            .sort((a, b) => (a.scrape_success_rate || 0) - (b.scrape_success_rate || 0))
                            .map(d => `
                                <tr>
                                    <td>${d.domain}</td>
                                    <td>${d.formal_name || 'N/A'}</td>
                                    <td>${d.scrape_attempts || 0}</td>
                                    <td>${d.scrape_failures || 0}</td>
                                    <td>${formatRate(d.scrape_success_rate)}</td>
                                </tr>
                            `).join('');

                        document.getElementById('scrape-loading').style.display = 'none';
                        document.getElementById('scrape-table').style.display = 'table';
                    }
                }
            } catch (error) {
                console.error('Failed to load domain stats:', error);
                document.getElementById('quality-loading').textContent = 'Error loading data';
                document.getElementById('scrape-loading').textContent = 'Error loading data';
            }
        }

        loadDomainStats();
    </script>
</body>
</html>
